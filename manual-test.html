<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Enhanced Optical Scanner Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f5f5f5;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: 500;
        }
        .loading { background: #e3f2fd; color: #1565c0; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
        .warning { background: #fff3e0; color: #ef6c00; }

        .test-section {
            background: white;
            margin: 20px 0;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 120px;
        }
        
        .btn.primary {
            background: #1976d2;
            color: white;
        }
        
        .btn.primary:hover:not(:disabled) {
            background: #1565c0;
        }
        
        .btn.success {
            background: #28a745;
            color: white;
        }
        
        .btn.success:hover:not(:disabled) {
            background: #218838;
        }
        
        .btn.danger {
            background: #dc3545;
            color: white;
        }
        
        .btn.danger:hover:not(:disabled) {
            background: #c82333;
        }
        
        .btn.warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn.warning:hover:not(:disabled) {
            background: #e0a800;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .license-section {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }
        
        .license-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 8px 0;
            font-family: Monaco, 'Courier New', monospace;
            font-size: 12px;
        }
        
        .camera-container {
            margin: 16px 0;
            text-align: center;
            position: relative;
            display: inline-block;
        }
        
        .camera-video {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: #000;
        }
        
        .scan-overlay {
            position: absolute;
            border: 3px solid #ffc107;
            border-radius: 8px;
            top: 25%;
            left: 15%;
            width: 70%;
            height: 50%;
            pointer-events: none;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        .scan-overlay::before {
            content: "Hold barcode here";
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 193, 7, 0.9);
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .countdown {
            font-size: 20px;
            font-weight: bold;
            color: #ffc107;
            text-align: center;
            margin: 10px 0;
            min-height: 25px;
        }
        
        .results {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
            font-family: Monaco, 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
        }
        
        .format-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 12px 0;
        }
        
        .format-tag {
            padding: 6px 12px;
            background: #e3f2fd;
            color: #1565c0;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .debug-info {
            background: #f1f3f4;
            border-radius: 6px;
            padding: 12px;
            margin: 16px 0;
            font-family: Monaco, 'Courier New', monospace;
            font-size: 11px;
            color: #5f6368;
            border: 1px solid #e0e0e0;
        }
        
        .scan-modes {
            background: #e8f5e8;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }
        
        .scan-modes h4 {
            margin: 0 0 12px 0;
            color: #2e7d32;
        }

        .mrz-validation {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
        }

        .validation-summary {
            margin-bottom: 12px;
        }

        .validation-fields {
            font-size: 14px;
        }

        .file-input {
            margin: 16px 0;
        }

        .file-input input[type="file"] {
            margin-right: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Enhanced Optical Scanner Test</h1>
        <p>Testing all plugins: QR Code, PDF417, Enhanced PDF417, and MRZ</p>
    </div>
    
    <div id="status" class="status loading">
        üì¶ Loading optical scanner library...
    </div>
    
    <!-- License Configuration -->
    <div class="test-section">
        <h3>üîë Dynamsoft License Configuration</h3>
        <div class="license-section">
            <p><strong>Optional:</strong> Enter your Dynamsoft license key to test enhanced PDF417 and MRZ scanning</p>
            <input type="text" id="licenseInput" class="license-input" 
                   placeholder="Paste your Dynamsoft license key here (optional)">
            <div class="controls">
                <button id="testLicense" class="btn primary">Test License</button>
                <button id="clearLicense" class="btn warning">Clear</button>
            </div>
            <div id="licenseStatus" style="margin-top: 8px; font-size: 12px;"></div>
        </div>
    </div>
    
    <!-- Camera Scanning Tests -->
    <div class="test-section">
        <h3>üìπ Camera Scanning Tests</h3>
        
        <div class="controls">
            <button id="startCamera" class="btn success">üìπ Start Camera</button>
            <button id="stopCamera" class="btn danger" disabled>‚èπÔ∏è Stop Camera</button>
        </div>
        
        <div id="cameraContainer" class="camera-container" style="display: none;">
            <video id="video" class="camera-video" autoplay muted playsinline width="640" height="480"></video>
            <div id="scanOverlay" class="scan-overlay" style="display: none;"></div>
        </div>
        
        <div class="scan-modes">
            <h4>üìä Scanning Options</h4>
            <div class="controls">
                <button id="scanAny" class="btn primary" disabled>üîç Auto-Detect Any Format</button>
                <button id="scanQR" class="btn primary" disabled>üì± QR Code Only</button>
                <button id="scanPDF417" class="btn primary" disabled>üìÑ PDF417 Only</button>
                <button id="scanEnhanced" class="btn primary" disabled>‚ö° Enhanced PDF417</button>
                <button id="scanMRZ" class="btn primary" disabled>üõÇ MRZ (Unified Camera)</button>
                <button id="scanMRZNative" class="btn success" disabled>üöÄ MRZ Native UI</button>
                <button id="stopScan" class="btn danger" disabled>‚èπÔ∏è Stop Scanning</button>
            </div>
        </div>
        
        <div id="progress" class="progress-bar" style="display: none;">
            <div id="progressFill" class="progress-fill"></div>
        </div>
        <div id="countdown" class="countdown"></div>
        
        <div id="cameraResults" class="results" style="display: none;"></div>
    </div>
    
    <!-- File Upload Tests -->
    <div class="test-section">
        <h3>üìÅ File Upload Tests</h3>
        
        <div class="scan-modes">
            <h4>üîç Basic Scanning (QR + PDF417)</h4>
            <div class="file-input">
                <input type="file" id="fileInput" accept="image/*" />
                <button id="scanFileAny" class="btn primary">üîç Auto-Detect</button>
                <button id="scanFileQR" class="btn primary">üì± QR Only</button>
                <button id="scanFilePDF417" class="btn primary">üìÑ PDF417 Only</button>
                <button id="scanFileEnhanced" class="btn primary">‚ö° Enhanced PDF417</button>
            </div>
            <div id="fileResults" class="results" style="display: none;"></div>
        </div>

        <div class="scan-modes">
            <h4>üõÇ MRZ Scanning</h4>
            <div class="file-input">
                <input type="file" id="mrzFileInput" accept="image/*" />
                <button id="scanMrzFile" class="btn primary">üõÇ Scan MRZ from File</button>
            </div>
            <div id="mrzFileResults" class="results" style="display: none;"></div>
            <div id="mrzValidation" class="mrz-validation" style="display: none;">
                <div id="mrzValidationContent"></div>
            </div>
        </div>

        <div class="scan-modes">
            <h4>üåê Multi-Format Scanning</h4>
            <div class="file-input">
                <input type="file" id="multiFormatFileInput" accept="image/*" />
                <button id="scanMultiFormatFile" class="btn success">üîç Scan All Formats</button>
            </div>
            <div id="multiFormatResults" class="results" style="display: none;"></div>
        </div>
    </div>
    
    <!-- Debug Information -->
    <div class="test-section">
        <h3>üõ†Ô∏è Debug Information</h3>
        
        <div class="format-list">
            <strong>Supported Formats:</strong>
            <div id="formatsList" class="format-list">
                <!-- Populated by JavaScript -->
            </div>
        </div>
        
        <div class="debug-info">
            <strong>Debug Information:</strong>
            <div id="debugInfo">Initializing...</div>
        </div>
    </div>

    <!-- Set trigger for manual test -->
    <script>window.manualTest = true;</script>
    
    <!-- Load the bundle -->
    <script src="./dist/bundle.js"></script>
    
    <script>
        // Global state
        let scanner = null;
        let mrzScanner = null;
        let videoStream = null;
        let isScanning = false;
        let scanTimeout = null;
        let progressInterval = null;
        let scanStartTime = null;

        // Get library reference
        const lib = window.OpticalScannerLib;
        
        // DOM elements
        const statusEl = document.getElementById('status');
        const licenseInput = document.getElementById('licenseInput');
        const licenseStatus = document.getElementById('licenseStatus');
        const videoEl = document.getElementById('video');
        const cameraContainer = document.getElementById('cameraContainer');
        const scanOverlay = document.getElementById('scanOverlay');
        const progressEl = document.getElementById('progress');
        const progressFill = document.getElementById('progressFill');
        const countdown = document.getElementById('countdown');
        const cameraResults = document.getElementById('cameraResults');
        const fileResults = document.getElementById('fileResults');
        const mrzFileResults = document.getElementById('mrzFileResults');
        const mrzValidation = document.getElementById('mrzValidation');
        const mrzValidationContent = document.getElementById('mrzValidationContent');
        const multiFormatResults = document.getElementById('multiFormatResults');
        const formatsList = document.getElementById('formatsList');
        const debugInfo = document.getElementById('debugInfo');

        // Utility functions
        function setStatus(message, type = 'loading') {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function setLicenseStatus(message, isError = false) {
            licenseStatus.textContent = message;
            licenseStatus.style.color = isError ? '#dc3545' : '#28a745';
        }

        function showResults(text, targetEl) {
            targetEl.style.display = 'block';
            targetEl.textContent = typeof text === 'object' ? JSON.stringify(text, null, 2) : text;
            targetEl.scrollTop = targetEl.scrollHeight;
        }

        function getMRZLicenseKey() {
            const key = licenseInput.value.trim();
            if(!key) {
                setStatus('‚ö†Ô∏è MRZ license key required for MRZ scanning', 'warning');
                return null;
            }
            return key;
        }

        function displayMRZValidation(validation) {
            if(!validation) {
                mrzValidation.style.display = 'none';
                return;
            }

            mrzValidation.style.display = 'block';

            let html = `<details open>
                <summary><strong>üìä MRZ Validation Report</strong></summary>
                <div class="validation-summary">
                    <p><strong>Overall Status:</strong> ${validation.overallStatus}</p>
                    <p><strong>Completeness:</strong> ${validation.statistics.overallCompleteness}%</p>
                    <p><strong>Valid Fields:</strong> ${validation.statistics.validFields}/${validation.statistics.totalFields}</p>
                </div>
                <div class="validation-fields">`;

            validation.fields.forEach(field => {
                const statusColor = field.status === 'valid' ? '#28a745' :
                    field.status === 'invalid' ? '#dc3545' : '#ffc107';
                html += `<div style="margin: 4px 0; padding: 4px; border-left: 3px solid ${statusColor};">
                    <strong>${field.label}:</strong> ${field.value || 'N/A'} 
                    <span style="color: ${statusColor};">${field.status}${field.critical ? ' (critical)' : ''}</span>
                </div>`;
            });

            html += '</div></details>';
            mrzValidationContent.innerHTML = html;
        }

        function updateDebugInfo() {
            const info = {
                libraryLoaded: !!lib,
                scannerReady: !!scanner,
                mrzScannerReady: !!mrzScanner,
                supportedFormats: mrzScanner ? mrzScanner.getSupportedFormats() : [],
                cameraActive: !!videoStream,
                dynamnsoftLicense: licenseInput.value ? 'Provided' : 'Not provided',
                timestamp: new Date().toISOString()
            };
            debugInfo.textContent = JSON.stringify(info, null, 2);
        }

        // Initialize library
        function initializeLibrary() {
            if (!lib) {
                setStatus('‚ùå Library not loaded', 'error');
                return;
            }

            try {
                // Create basic scanner (QR + PDF417 + Enhanced PDF417)
                const basicPlugins = [
                    lib.qrCodePlugin,
                    lib.pdf417Plugin,
                    lib.enhancedPdf417Plugin
                ].filter(plugin => !!plugin);

                scanner = new lib.OpticalScanner({ plugins: basicPlugins });

                // Create MRZ-enabled scanner (includes all plugins)
                const allPlugins = [
                    lib.qrCodePlugin,
                    lib.pdf417Plugin,
                    lib.enhancedPdf417Plugin,
                    lib.mrzPlugin
                ].filter(plugin => !!plugin);

                mrzScanner = new lib.OpticalScanner({ plugins: allPlugins });

                // Display supported formats
                const formats = mrzScanner.getSupportedFormats();
                formatsList.innerHTML = '';
                formats.forEach(format => {
                    const tag = document.createElement('div');
                    tag.className = 'format-tag';
                    tag.textContent = format.toUpperCase();
                    formatsList.appendChild(tag);
                });

                setStatus(`‚úÖ Scanner ready! ${formats.length} plugins loaded`, 'success');
                updateDebugInfo();

                // Enable buttons
                document.getElementById('startCamera').disabled = false;
                document.getElementById('testLicense').disabled = false;

            } catch (error) {
                console.error('Scanner initialization failed:', error);
                setStatus(`‚ùå Scanner initialization failed: ${error.message}`, 'error');
            }
        }

        // Camera functions
        async function startCamera() {
            try {
                setStatus('üìπ Starting camera...', 'loading');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                videoStream = stream;
                videoEl.srcObject = stream;
                
                await new Promise(resolve => {
                    videoEl.onloadedmetadata = resolve;
                });
                
                await videoEl.play();
                cameraContainer.style.display = 'block';
                
                setStatus('‚úÖ Camera active - Ready to scan!', 'success');
                updateDebugInfo();
                
                // Enable scan buttons, disable start camera, enable stop camera
                document.getElementById('scanAny').disabled = false;
                document.getElementById('scanQR').disabled = false;
                document.getElementById('scanPDF417').disabled = false;
                document.getElementById('scanEnhanced').disabled = false;
                document.getElementById('scanMRZ').disabled = false;
                document.getElementById('scanMRZNative').disabled = false;
                document.getElementById('startCamera').disabled = true;
                document.getElementById('stopCamera').disabled = false;
                
            } catch (error) {
                setStatus(`‚ùå Camera failed: ${error.message}`, 'error');
            }
        }

        function stopCamera() {
            console.log('üìπ EVENT: Stop camera button clicked');
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                cameraContainer.style.display = 'none';
                
                // Stop any ongoing scanning
                stopScanning();
                
                // Reset ALL button states properly
                document.getElementById('startCamera').disabled = false;
                document.getElementById('stopCamera').disabled = true;
                document.getElementById('scanAny').disabled = true;
                document.getElementById('scanQR').disabled = true;
                document.getElementById('scanPDF417').disabled = true;
                document.getElementById('scanEnhanced').disabled = true;
                document.getElementById('scanMRZ').disabled = true;
                document.getElementById('scanMRZNative').disabled = true;
                document.getElementById('stopScan').disabled = true;
                
                setStatus('üì∑ Camera stopped', 'loading');
                updateDebugInfo();
            }
        }

        function startProgress(duration, message) {
            progressEl.style.display = 'block';
            scanOverlay.style.display = 'block';
            
            let progress = 0;
            const interval = 100;
            const increment = (interval / duration) * 100;
            
            scanStartTime = Date.now();
            
            progressInterval = setInterval(() => {
                progress += increment;
                progressFill.style.width = Math.min(progress, 100) + '%';
                
                const elapsed = Date.now() - scanStartTime;
                const remaining = Math.max(0, duration - elapsed);
                countdown.textContent = `${message} (${Math.ceil(remaining / 1000)}s)`;
                
                if (progress >= 100) {
                    stopProgress();
                }
            }, interval);
        }

        function stopProgress() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            progressEl.style.display = 'none';
            scanOverlay.style.display = 'none';
            progressFill.style.width = '0%';
            countdown.textContent = '';
        }

        function stopScanning() {
            isScanning = false;
            if (scanTimeout) {
                clearTimeout(scanTimeout);
                scanTimeout = null;
            }
            stopProgress();
            
            // FIXED: Properly re-enable stop camera button after scanning
            document.getElementById('stopScan').disabled = true;
            if (videoStream) {
                document.getElementById('stopCamera').disabled = false;
            }
            
            setStatus('‚èπÔ∏è Scanning stopped', 'warning');
        }

        async function performScan(options, timeout = 10000, message = 'Scanning') {
            if (isScanning || !scanner) return;
            
            isScanning = true;
            document.getElementById('stopScan').disabled = false;
            
            try {
                setStatus(`üîç ${message}...`, 'loading');
                startProgress(timeout, message);
                
                // Use mrzScanner if MRZ format is requested, otherwise use basic scanner
                const scannerToUse = options.formats.includes('mrz') ? mrzScanner : scanner;
                
                scanTimeout = setTimeout(() => {
                    stopScanning();
                    setStatus('‚è±Ô∏è Scan timeout - No codes detected', 'warning');
                }, timeout);
                
                const results = await scannerToUse.scan(videoEl, options);
                
                clearTimeout(scanTimeout);
                stopProgress();
                
                showResults(results, cameraResults);
                
                if (results.length > 0) {
                    // Check for MRZ validation data
                    const mrzResult = results.find(r => r.format === 'mrz' && r.data?.validation);
                    if (mrzResult) {
                        displayMRZValidation(mrzResult.data.validation);
                    }
                    
                    setStatus(`‚úÖ Found ${results.length} code(s)!`, 'success');
                } else {
                    setStatus('‚ö†Ô∏è No codes detected', 'warning');
                }
                
            } catch (error) {
                clearTimeout(scanTimeout);
                stopProgress();
                setStatus(`‚ùå Scan failed: ${error.message}`, 'error');
                showResults({error: error.message}, cameraResults);
            }
            
            isScanning = false;
            
            // FIXED: Properly restore button states after scanning
            document.getElementById('stopScan').disabled = true;
            if (videoStream) {
                document.getElementById('stopCamera').disabled = false;
            }
        }

        // FIXED: MRZ native camera scanning - Stop unified camera first
        async function scanMRZNative() {
            const licenseKey = getMRZLicenseKey();
            if (!licenseKey || !mrzScanner) return;

            try {
                // STEP 1: Stop unified camera if running
                if (videoStream) {
                    console.log('üöÄ Stopping unified camera before launching native scanner...');
                    stopCamera();
                    // Brief delay to ensure camera is properly released
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                setStatus('üöÄ Opening MRZ native scanner...', 'loading');

                // STEP 2: Launch native scanner with clean camera access
                const results = await mrzScanner.scan(null, {
                    formats: ['mrz'],
                    mode: 'first',
                    pluginOptions: {
                        mrz: {
                            licenseKey,
                            mrzMode: 'camera' // Native Dynamsoft UI
                        }
                    }
                });

                showResults(results, cameraResults);

                if (results.length > 0 && results[0].data?.validation) {
                    displayMRZValidation(results[0].data.validation);
                    setStatus(`‚úÖ MRZ scanned successfully (${results[0].data.validation.overallStatus})`, 'success');
                } else if (results.length > 0) {
                    setStatus('‚úÖ MRZ scanned successfully', 'success');
                } else {
                    setStatus('‚ö†Ô∏è No MRZ detected', 'warning');
                }
            } catch (error) {
                setStatus(`‚ùå MRZ native scan failed: ${error.message}`, 'error');
                showResults({error: error.message}, cameraResults);
            }
        }

        // File scanning functions
        async function scanFile(formats, mode = 'first', targetElement = fileResults) {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file || !scanner) return;

            try {
                setStatus(`üîç Scanning file for ${formats.join(', ')}...`, 'loading');

                const scannerToUse = formats.includes('mrz') ? mrzScanner : scanner;
                const options = { formats, mode };

                // Add license for enhanced scanning
                const licenseKey = licenseInput.value.trim();
                if (licenseKey && (formats.includes('pdf417_enhanced') || formats.includes('mrz'))) {
                    options.pluginOptions = {};
                    if (formats.includes('pdf417_enhanced')) {
                        options.pluginOptions.pdf417_enhanced = { license: licenseKey };
                    }
                    if (formats.includes('mrz')) {
                        options.pluginOptions.mrz = { licenseKey, mrzMode: 'file' };
                    }
                }

                const results = await scannerToUse.scan(file, options);

                showResults(results, targetElement);

                if (results.length > 0) {
                    setStatus(`‚úÖ Found ${results.length} code(s) in file`, 'success');
                } else {
                    setStatus('‚ö†Ô∏è No codes detected in file', 'warning');
                }
            } catch (error) {
                setStatus(`‚ùå File scan failed: ${error.message}`, 'error');
                showResults({error: error.message}, targetElement);
            }
        }

        async function scanMRZFile() {
            const fileInput = document.getElementById('mrzFileInput');
            const file = fileInput.files[0];
            const licenseKey = getMRZLicenseKey();
            if (!file || !licenseKey || !mrzScanner) return;

            try {
                setStatus('üîç Scanning MRZ from file...', 'loading');

                const results = await mrzScanner.scan(file, {
                    formats: ['mrz'],
                    mode: 'first',
                    pluginOptions: {
                        mrz: { licenseKey, mrzMode: 'file' }
                    }
                });

                showResults(results, mrzFileResults);

                if (results.length > 0 && results[0].data?.validation) {
                    displayMRZValidation(results[0].data.validation);
                    setStatus(`‚úÖ MRZ extracted from file (${results[0].data.validation.overallStatus})`, 'success');
                } else if (results.length > 0) {
                    setStatus('‚úÖ MRZ extracted from file', 'success');
                } else {
                    setStatus('‚ö†Ô∏è No MRZ detected in file', 'warning');
                }
            } catch (error) {
                setStatus(`‚ùå MRZ file scan failed: ${error.message}`, 'error');
                showResults({error: error.message}, mrzFileResults);
            }
        }

        async function scanMultiFormatFile() {
            const fileInput = document.getElementById('multiFormatFileInput');
            const file = fileInput.files[0];
            if (!file || !mrzScanner) return;

            try {
                setStatus('üîç Scanning all formats from file...', 'loading');

                const options = {
                    formats: ['qr_code', 'pdf417', 'mrz'],
                    mode: 'all'
                };

                const licenseKey = licenseInput.value.trim();
                if (licenseKey) {
                    options.pluginOptions = {
                        mrz: { licenseKey, mrzMode: 'file' }
                    };
                }

                const results = await mrzScanner.scan(file, options);

                showResults(results, multiFormatResults);

                if (results.length > 0) {
                    setStatus(`‚úÖ Found ${results.length} code(s) in file`, 'success');
                } else {
                    setStatus('‚ö†Ô∏è No codes detected in file', 'warning');
                }
            } catch (error) {
                setStatus(`‚ùå Multi-format file scan failed: ${error.message}`, 'error');
                showResults({error: error.message}, multiFormatResults);
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            updateDebugInfo();
        });

        document.getElementById('testLicense').addEventListener('click', () => {
            const license = licenseInput.value.trim();
            if (license) {
                setLicenseStatus('‚úÖ License provided (not validated until scanning)');
            } else {
                setLicenseStatus('‚ùå Please enter a license key', true);
            }
            updateDebugInfo();
        });

        document.getElementById('clearLicense').addEventListener('click', () => {
            licenseInput.value = '';
            setLicenseStatus('');
            updateDebugInfo();
        });

        document.getElementById('startCamera').addEventListener('click', () => {
            console.log('üìπ EVENT: Start camera button clicked');
            startCamera();
        });
        
        // FIXED: Stop camera event listener
        document.getElementById('stopCamera').addEventListener('click', () => {
            stopCamera();
        });

        // Camera scanning buttons
        document.getElementById('scanAny').addEventListener('click', () => {
            console.log('üîç EVENT: Scan Any button clicked');
            const formats = mrzScanner.getSupportedFormats();
            console.log('üîç EVENT: Auto-detect formats:', formats);
            
            // FIXED: Include MRZ license key for auto-detect if available
            const options = { formats, mode: 'first' };
            const licenseKey = licenseInput.value.trim();
            
            if (licenseKey && formats.includes('mrz')) {
                options.pluginOptions = {
                    mrz: { licenseKey, mrzMode: 'element' }
                };
                console.log('üîç EVENT: Using MRZ license for auto-detect');
            }
            
            performScan(options, 10000, 'Auto-detecting any format');
        });

        document.getElementById('scanQR').addEventListener('click', () => {
            console.log('üîç EVENT: Scan QR button clicked');
            performScan({ formats: ['qr_code'], mode: 'first' }, 5000, 'Scanning QR codes');
        });

        document.getElementById('scanPDF417').addEventListener('click', () => {
            console.log('üîç EVENT: Scan PDF417 button clicked');
            performScan({ formats: ['pdf417'], mode: 'first' }, 8000, 'Scanning PDF417 (basic)');
        });

        document.getElementById('scanEnhanced').addEventListener('click', () => {
            console.log('üîç EVENT: Scan Enhanced button clicked');
            const license = licenseInput.value.trim();
            const options = {
                formats: ['pdf417_enhanced'],
                mode: 'first'
            };
            if (license) {
                options.pluginOptions = { pdf417_enhanced: { license } };
                console.log('üîç EVENT: Using Dynamsoft license for enhanced scan');
            } else {
                console.log('üîç EVENT: No license provided, using fallback scanning');
            }
            performScan(options, 10000, 'Enhanced PDF417 scan');
        });

        document.getElementById('scanMRZ').addEventListener('click', () => {
            console.log('üîç EVENT: Scan MRZ button clicked');
            const licenseKey = getMRZLicenseKey();
            if (!licenseKey) return;
            
            const options = {
                formats: ['mrz'],
                mode: 'first',
                pluginOptions: {
                    mrz: { licenseKey, mrzMode: 'element' }
                }
            };
            performScan(options, 15000, 'Scanning MRZ (unified camera)');
        });

        document.getElementById('scanMRZNative').addEventListener('click', () => {
            console.log('üîç EVENT: Scan MRZ Native button clicked');
            scanMRZNative();
        });

        document.getElementById('stopScan').addEventListener('click', () => {
            console.log('üîç EVENT: Stop scan button clicked');
            stopScanning();
        });

        // File scanning buttons
        document.getElementById('scanFileAny').addEventListener('click', () => {
            console.log('üìÅ EVENT: Scan File Any button clicked');
            scanFile(['qr_code', 'pdf417'], 'first');
        });

        document.getElementById('scanFileQR').addEventListener('click', () => {
            console.log('üìÅ EVENT: Scan File QR button clicked');
            scanFile(['qr_code'], 'first');
        });

        document.getElementById('scanFilePDF417').addEventListener('click', () => {
            console.log('üìÅ EVENT: Scan File PDF417 button clicked');
            scanFile(['pdf417'], 'first');
        });

        document.getElementById('scanFileEnhanced').addEventListener('click', () => {
            console.log('üìÅ EVENT: Scan File Enhanced button clicked');
            scanFile(['pdf417_enhanced'], 'first');
        });

        document.getElementById('scanMrzFile').addEventListener('click', () => {
            console.log('üìÅ EVENT: Scan MRZ File button clicked');
            scanMRZFile();
        });

        document.getElementById('scanMultiFormatFile').addEventListener('click', () => {
            console.log('üìÅ EVENT: Scan Multi-Format File button clicked');
            scanMultiFormatFile();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
        });

        // Initialize when library is ready
        if (lib) {
            initializeLibrary();
        } else {
            setStatus('‚ùå OpticalScannerLib not found', 'error');
        }
    </script>
</body>
</html>